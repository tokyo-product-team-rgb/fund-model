<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VC Fund Model Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Copernicus Trial';
      src: url('fonts/CopernicusTrial-Book.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Copernicus Trial';
      src: url('fonts/CopernicusTrial-Medium.ttf') format('truetype');
      font-weight: 500;
      font-style: normal;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      /* Text colors */
      --text-primary: #111111;
      --text-secondary: #44403C;
      --text-tertiary: #78716C;
      --text-link: #1D736C;
      --text-link-hover: #2A8F87;
      --text-error: #C5624E;

      /* Background colors */
      --bg-primary: #F9F9F9;
      --bg-secondary: #FDFDFD;
      --bg-tertiary: #F7F6F4;
      --bg-hover: #F5F4F3;
      --bg-hover-darker: #ECEAE7;
      --bg-white: #FFFFFF;
      --bg-accent: #2A8F87;
      --bg-accent-dark: #1D736C;

      /* Lines/Borders */
      --line-subtle: #E8E5E1;
      --line-default: #D5D2CD;
      --line-neutral: rgba(0,0,0,0.06);

      /* Chart colors */
      --chart-primary: #2A8F87;
      --chart-secondary: #E07A3F;
      --chart-tertiary: #E3B341;
      --chart-reference: #4C78A8;
      --chart-outlier: #C06C84;
      --chart-warning: #B94A48;

      /* Highlights */
      --highlight-emphasis: #F4E3B1;
      --highlight-info: #E3EBF5;
      --highlight-warning: #F6E3E1;
      --highlight-brand: #E5FBF8;

      /* GP/LP colors */
      --gp-color: #7c3aed;
      --lp-color: #2A8F87;

      /* Typography */
      --serif: 'Copernicus Trial', Georgia, serif;
      --sans: 'Hanken Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;

      /* Shadows */
      --shadow-card: 0 4px 8px rgba(0,0,0,0.04), 0 2px 4px rgba(0,0,0,0.06);
      --shadow-card-hover: 0 8px 16px rgba(0,0,0,0.06), 0 4px 8px rgba(0,0,0,0.04);

      /* Radius */
      --radius: 24px;

      /* Status colors */
      --green: #1D736C;
      --red: #B94A48;
      --yellow: #ca8a04;
    }

    html { font-size: 16px; }
    body {
      font-family: var(--sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.65;
    }

    .nav-bar {
      display: flex;
      justify-content: center;
      gap: 0;
      background: var(--bg-secondary);
      font-size: 0.8rem;
      font-weight: 500;
    }
    .nav-bar a {
      text-decoration: none;
      color: var(--text-tertiary);
      padding: 0.7rem 1.5rem;
      margin: 4px 0;
      border-radius: 999px;
      transition: color 0.2s, background 0.2s;
    }
    .nav-bar a:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .nav-bar a.active {
      background: var(--bg-hover-darker);
      color: var(--text-primary);
    }

    .masthead {
      background: transparent;
    }
    .masthead-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      text-align: center;
    }
    .masthead .overline {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
      margin-bottom: 0.5rem;
    }
    .masthead h1 {
      font-family: var(--serif);
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 400;
      color: var(--text-primary);
    }
    .masthead .subtitle {
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 2rem;
    }
    @media (max-width: 1000px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow-card);
      margin-bottom: 1.5rem;
    }
    .panel:hover {
      box-shadow: var(--shadow-card-hover);
    }

    .panel-title {
      font-family: var(--serif);
      font-size: 1.35rem;
      font-weight: 500;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--line-subtle);
      color: var(--text-secondary);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
      margin-bottom: 0.35rem;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    input[type="number"] {
      width: 100%;
      padding: 0.5rem 0.6rem;
      font-size: 0.9rem;
      font-family: var(--sans);
      border: 1px solid var(--line-default);
      border-radius: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    input:focus {
      outline: none;
      border-color: var(--bg-accent);
      box-shadow: 0 0 0 3px rgba(42,143,135,0.1);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--line-default);
      appearance: none;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--bg-accent);
      cursor: pointer;
    }

    .slider-value {
      min-width: 50px;
      text-align: right;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .section-divider {
      border: none;
      border-top: 1px dashed var(--line-subtle);
      margin: 1.25rem 0;
    }

    .section-label {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .allocation-total {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      margin-top: 1rem;
      border-radius: 8px;
      background: var(--bg-tertiary);
      font-size: 0.85rem;
    }
    .allocation-total.valid {
      background: #dcfce7;
    }
    .allocation-total.invalid {
      background: #fef3c7;
      border: 1px solid #f59e0b;
    }
    .allocation-label {
      font-weight: 500;
      color: var(--text-secondary);
    }
    .allocation-value {
      font-weight: 700;
      color: var(--text-primary);
    }
    .allocation-total.valid .allocation-value {
      color: #166534;
    }
    .allocation-total.invalid .allocation-value {
      color: #b45309;
    }
    .allocation-warning {
      margin-left: auto;
      font-weight: 600;
      color: #b45309;
    }

    /* Reference Section */
    .reference-section {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    .reference-details {
      background: var(--bg-white);
      border-radius: 16px;
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }
    .reference-summary {
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-tertiary);
      border: none;
      list-style: none;
    }
    .reference-summary::-webkit-details-marker {
      display: none;
    }
    .reference-summary::before {
      content: '‚ñ∂ ';
      font-size: 0.75rem;
      margin-right: 0.5rem;
    }
    details[open] .reference-summary::before {
      content: '‚ñº ';
    }
    .reference-content {
      padding: 1.5rem;
      display: grid;
      gap: 1.5rem;
    }
    .ref-step {
      border-bottom: 1px solid var(--line-subtle);
      padding-bottom: 1.25rem;
    }
    .ref-step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .ref-step h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .formula-box {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }
    .formula-box code {
      display: block;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8rem;
      color: var(--text-primary);
      margin: 0.25rem 0;
    }
    .ref-example {
      font-size: 0.8rem;
      color: var(--text-tertiary);
      font-style: italic;
    }
    .waterfall-ref {
      display: grid;
      gap: 0.5rem;
    }
    .wf-ref-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .wf-ref-num {
      width: 24px;
      height: 24px;
      background: var(--text-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    .wf-ref-name {
      font-weight: 600;
      min-width: 140px;
    }
    .wf-ref-desc {
      color: var(--text-secondary);
    }
    .ref-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .ref-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--line-subtle);
    }
    .ref-table td:first-child {
      width: 120px;
      color: var(--text-primary);
    }
    .ref-table td:last-child {
      color: var(--text-secondary);
    }

    /* Output Cards */
    .output-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 700px) {
      .output-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .output-card {
      background: var(--bg-tertiary);
      border: none;
      border-radius: 16px;
      padding: 0.85rem;
      text-align: center;
    }
    .output-card.highlight {
      background: var(--highlight-brand);
    }
    .output-card.gp {
      background: #f3e8ff;
    }
    .output-card.lp {
      background: var(--highlight-brand);
    }

    .output-value {
      font-family: var(--serif);
      font-size: 1.5rem;
      font-weight: 500;
      line-height: 1.2;
    }
    .output-value.green { color: var(--green); }
    .output-value.red { color: var(--red); }
    .output-value.gp { color: var(--gp-color); }
    .output-value.lp { color: var(--lp-color); }

    .output-label {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
      margin-top: 0.25rem;
    }

    /* Waterfall */
    .waterfall {
      margin-top: 1rem;
    }

    .waterfall-step {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .waterfall-step.header {
      background: var(--text-primary);
      color: #fff;
      font-weight: 500;
    }
    /* Cash Flow Waterfall */
    .cashflow-section {
      margin-bottom: 1rem;
    }
    .cashflow-header {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      padding: 0.5rem 0.75rem;
      border-radius: 8px 8px 0 0;
      color: white;
    }
    .cashflow-header.sources { background: #3b82f6; }
    .cashflow-header.uses { background: #6b7280; }
    .cashflow-header.investments { background: #8b5cf6; }
    .cashflow-header.returns { background: #10b981; }
    .cashflow-header.waterfall { background: #f59e0b; }
    .cashflow-header.totals { background: #111; }
    
    .cashflow-row {
      display: flex;
      align-items: center;
      padding: 0.6rem 0.75rem;
      border-left: 3px solid transparent;
      background: var(--bg-white);
      border-bottom: 1px solid var(--line-subtle);
      font-size: 0.85rem;
    }
    .cashflow-row:last-child {
      border-radius: 0 0 8px 8px;
    }
    .cashflow-row.source { border-left-color: #3b82f6; }
    .cashflow-row.expense { border-left-color: #ef4444; background: #fef2f2; }
    .cashflow-row.invest { border-left-color: #8b5cf6; }
    .cashflow-row.return { border-left-color: #10b981; background: #f0fdf4; }
    .cashflow-row.subtotal { 
      background: var(--bg-tertiary); 
      font-weight: 600;
      border-left-color: #6b7280;
    }
    .cashflow-row.subtotal.highlight-green {
      background: #dcfce7;
      border-left-color: #10b981;
    }
    .cashflow-row.wf { border-left-color: #f59e0b; }
    .cashflow-row.wf.lp-style { background: #f0fdfa; }
    .cashflow-row.wf.gp-style { background: #faf5ff; }
    .cashflow-row.wf.split-style { background: var(--bg-tertiary); }
    .cashflow-row.total { font-weight: 600; }
    .cashflow-row.lp-total { background: #f0fdfa; border-left-color: var(--lp-color); }
    .cashflow-row.gp-total { background: #faf5ff; border-left-color: var(--gp-color); }
    .cashflow-row.verify { 
      background: #f0fdf4; 
      border-left-color: #10b981;
      font-size: 0.8rem;
    }
    
    .cf-icon {
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    .cf-label {
      width: 140px;
      font-weight: 500;
      flex-shrink: 0;
    }
    .cf-desc {
      flex: 1;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      padding: 0 0.5rem;
    }
    .cf-amount {
      width: 120px;
      text-align: right;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }
    .cf-amount.negative { color: #ef4444; }
    .cf-amount.positive { color: #10b981; }
    .cf-amount.lp-color { color: var(--lp-color); }
    .cf-amount.gp-color { color: var(--gp-color); }
    .cf-amount.split-amounts {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.8rem;
      gap: 2px;
    }
    .lp-color { color: var(--lp-color); }
    .gp-color { color: var(--gp-color); }
    
    @media (max-width: 700px) {
      .cf-desc { display: none; }
      .cf-label { width: 100px; font-size: 0.8rem; }
      .cf-amount { width: 90px; }
    }

    /* Breakdown Table */
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .breakdown-table th {
      text-align: left;
      padding: 0.5rem 0.4rem;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
      border-bottom: 1px solid var(--line-default);
    }
    .breakdown-table td {
      padding: 0.55rem 0.4rem;
      border-bottom: 1px solid var(--line-subtle);
    }
    .breakdown-table tr:last-child td { border-bottom: none; }
    .breakdown-table .engine { font-weight: 500; }
    .breakdown-table .num { text-align: right; font-weight: 600; }
    .breakdown-table .pos { color: var(--green); }

    .breakdown-table tfoot td {
      font-weight: 600;
      border-top: 1px solid var(--line-default);
      background: var(--bg-tertiary);
    }

    /* Scenario Status */
    .scenario-status {
      padding: 0.85rem 1rem;
      border-radius: 16px;
      margin-bottom: 1.25rem;
      font-size: 0.85rem;
    }
    .scenario-status.success {
      background: var(--highlight-brand);
      color: var(--green);
    }
    .scenario-status.warning {
      background: var(--highlight-emphasis);
      color: #854d0e;
    }
    .scenario-status.danger {
      background: var(--highlight-warning);
      color: var(--red);
    }

    /* Distribution Bar */
    .dist-bar-container {
      margin: 1rem 0;
    }
    .dist-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      font-weight: 500;
      margin-bottom: 0.4rem;
    }
    .dist-bar {
      height: 28px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      background: var(--line-default);
    }
    .dist-bar-lp {
      background: var(--lp-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .dist-bar-gp {
      background: var(--gp-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .footer {
      text-align: center;
      padding: 2rem;
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Saved Versions */
    .versions-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .versions-header input {
      flex: 1;
      padding: 0.5rem 0.6rem;
      font-size: 0.85rem;
      border: 1px solid var(--line-default);
      border-radius: 12px;
      background: var(--bg-primary);
    }
    .versions-header input:focus {
      outline: none;
      border-color: var(--bg-accent);
    }
    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 500;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: var(--bg-accent);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--bg-accent-dark);
    }
    .btn-sm {
      padding: 0.35rem 0.6rem;
      font-size: 0.7rem;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-tertiary);
      border: 1px solid var(--line-default);
    }
    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .btn-danger {
      color: var(--red);
    }
    .btn-danger:hover {
      background: var(--highlight-warning);
    }
    .version-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .version-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem;
      border-radius: 12px;
      margin-bottom: 0.4rem;
      background: var(--bg-tertiary);
      border: none;
    }
    .version-item:hover {
      background: var(--bg-hover);
    }
    .version-name {
      flex: 1;
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .version-meta {
      font-size: 0.7rem;
      color: var(--text-tertiary);
    }
    .version-empty {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }

    /* Insight box */
    .insight-box {
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 12px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .insight-box strong {
      font-weight: 500;
    }
  </style>
</head>
<body>

  <nav class="nav-bar">
    <a href="index.html" class="active">Fund Model</a>
    <a href="vc-research.html">VC Research</a>
  </nav>

  <header class="masthead">
    <div class="masthead-inner">
      <div class="overline">Portfolio construction tool</div>
      <h1>VC Fund Model Simulator</h1>
      <p class="subtitle">Stress-test portfolio economics with full waterfall analysis</p>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- INPUTS PANEL -->
      <div>
        <div class="panel">
          <h2 class="panel-title">Saved versions</h2>
          <div class="versions-header">
            <input type="text" id="versionName" placeholder="Version name...">
            <button class="btn btn-primary" onclick="saveVersion()">Save</button>
          </div>
          <div class="version-list" id="versionList">
            <div class="version-empty">No saved versions yet</div>
          </div>
        </div>

        <div class="panel">
          <h2 class="panel-title">Fund parameters</h2>

          <div class="section-label">Fund basics</div>

          <div class="input-group">
            <label class="input-label">Fund size ($M)</label>
            <input type="number" id="fundSize" value="1000" min="100" max="5000" step="50">
          </div>

          <div class="input-group">
            <label class="input-label">Management fee (%)</label>
            <div class="input-row">
              <input type="range" id="mgmtFee" value="2" min="1" max="3" step="0.25">
              <span class="slider-value" id="mgmtFeeVal">2%</span>
              <span class="slider-value" id="mgmtFeeDollar" style="color: var(--text-secondary); min-width: 70px;">$200M</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Expense ratio (%)</label>
            <div class="input-row">
              <input type="range" id="expenseRatio" value="0.5" min="0" max="2" step="0.1">
              <span class="slider-value" id="expenseRatioVal">0.5%</span>
              <span class="slider-value" id="expenseRatioDollar" style="color: var(--text-secondary); min-width: 70px;">$50M</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Fund life (years)</label>
            <input type="number" id="fundLife" value="10" min="5" max="15">
          </div>

          <div class="input-group">
            <label class="input-label">Target net MOIC</label>
            <input type="number" id="targetMoic" value="5" min="2" max="10" step="0.5">
          </div>

          <hr class="section-divider">
          <div class="section-label">Waterfall terms</div>

          <div class="input-group">
            <label class="input-label">Carried interest (%)</label>
            <div class="input-row">
              <input type="range" id="carryPct" value="20" min="10" max="30" step="1">
              <span class="slider-value" id="carryPctVal">20%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Preferred return / hurdle (%)</label>
            <div class="input-row">
              <input type="range" id="hurdleRate" value="8" min="0" max="12" step="1">
              <span class="slider-value" id="hurdleRateVal">8%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">GP catch-up (%)</label>
            <div class="input-row">
              <input type="range" id="catchupPct" value="100" min="0" max="100" step="10">
              <span class="slider-value" id="catchupPctVal">100%</span>
            </div>
          </div>

          <hr class="section-divider">
          <div class="section-label">Capital allocation</div>

          <div class="input-group">
            <label class="input-label">Discovery (%)</label>
            <div class="input-row">
              <input type="range" id="discoveryPct" value="15" min="5" max="30" step="1">
              <span class="slider-value" id="discoveryPctVal">15%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Core (%)</label>
            <div class="input-row">
              <input type="range" id="corePct" value="73" min="50" max="85" step="1">
              <span class="slider-value" id="corePctVal">73%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Breakout (%)</label>
            <div class="input-row">
              <input type="range" id="breakoutPct" value="12" min="5" max="25" step="1">
              <span class="slider-value" id="breakoutPctVal">12%</span>
            </div>
          </div>

          <div class="allocation-total" id="allocationTotal">
            <span class="allocation-label">Total allocation:</span>
            <span class="allocation-value" id="allocationValue">100%</span>
            <span class="allocation-warning" id="allocationWarning" style="display: none;">‚ö†Ô∏è Missing: <span id="allocationMissing">0%</span></span>
          </div>

        </div>

        <div class="panel">
          <h2 class="panel-title">Position assumptions</h2>

          <div class="section-label">Position counts</div>

          <div class="input-group">
            <label class="input-label">Discovery positions</label>
            <input type="number" id="discoveryCount" value="146" min="20" max="300">
          </div>

          <div class="input-group">
            <label class="input-label">Core positions</label>
            <input type="number" id="coreCount" value="10" min="5" max="30">
          </div>

          <div class="input-group">
            <label class="input-label">Breakout positions</label>
            <input type="number" id="breakoutCount" value="3" min="1" max="10">
          </div>

          <hr class="section-divider">
          <div class="section-label">Return multiples (survivors)</div>

          <div class="input-group">
            <label class="input-label">Discovery avg multiple</label>
            <input type="number" id="discoveryMult" value="8" min="1" max="50" step="0.5">
          </div>

          <div class="input-group">
            <label class="input-label">Core avg multiple</label>
            <input type="number" id="coreMult" value="12" min="2" max="30" step="0.5">
          </div>

          <div class="input-group">
            <label class="input-label">Breakout avg multiple</label>
            <input type="number" id="breakoutMult" value="25" min="5" max="100" step="1">
          </div>

          <hr class="section-divider">
          <div class="section-label">Loss rates</div>

          <div class="input-group">
            <label class="input-label">Discovery loss rate</label>
            <div class="input-row">
              <input type="range" id="discoveryLoss" value="60" min="30" max="80" step="5">
              <span class="slider-value" id="discoveryLossVal">60%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Core loss rate</label>
            <div class="input-row">
              <input type="range" id="coreLoss" value="30" min="10" max="50" step="5">
              <span class="slider-value" id="coreLossVal">30%</span>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Breakout loss rate</label>
            <div class="input-row">
              <input type="range" id="breakoutLoss" value="10" min="0" max="30" step="5">
              <span class="slider-value" id="breakoutLossVal">10%</span>
            </div>
          </div>

        </div>
      </div>

      <!-- OUTPUTS PANEL -->
      <div>

        <div class="panel">
          <h2 class="panel-title">Fund economics</h2>

          <div id="scenarioStatus" class="scenario-status success">
            <strong>Target achievable</strong> ‚Äî Model produces 5.2x net MOIC
          </div>

          <div class="output-grid">
            <div class="output-card highlight">
              <div class="output-value green" id="netMoic">5.2x</div>
              <div class="output-label">Net MOIC</div>
            </div>
            <div class="output-card">
              <div class="output-value" id="grossMoic">7.4x</div>
              <div class="output-label">Gross MOIC</div>
            </div>
            <div class="output-card highlight">
              <div class="output-value green" id="netIrr">28.5%</div>
              <div class="output-label">Net IRR</div>
            </div>
            <div class="output-card">
              <div class="output-value" id="investable">$830M</div>
              <div class="output-label">Investable capital</div>
            </div>
          </div>

          <div class="output-grid">
            <div class="output-card">
              <div class="output-value" id="deployedCapital">$830M</div>
              <div class="output-label">Deployed capital <span id="deployedPct" style="font-size: 0.75rem; color: var(--text-tertiary);">(100%)</span></div>
            </div>
            <div class="output-card">
              <div class="output-value" id="grossProceeds">$6.1B</div>
              <div class="output-label">Gross proceeds</div>
            </div>
            <div class="output-card lp">
              <div class="output-value lp" id="lpTotal">$4.2B</div>
              <div class="output-label">LP total</div>
            </div>
            <div class="output-card gp">
              <div class="output-value gp" id="gpTotal">$1.0B</div>
              <div class="output-label">GP total</div>
            </div>
          </div>

          <div class="output-grid">
            <div class="output-card highlight">
              <div class="output-value green" id="tvpi">5.6x</div>
              <div class="output-label">TVPI</div>
            </div>
            <div class="output-card highlight">
              <div class="output-value green" id="dpi">5.6x</div>
              <div class="output-label">DPI</div>
            </div>
            <div class="output-card">
              <div class="output-value" id="rvpi">0.0x</div>
              <div class="output-label">RVPI</div>
            </div>
            <div class="output-card">
              <div class="output-value" id="lpMoic">4.2x</div>
              <div class="output-label">LP MOIC</div>
            </div>
          </div>

          <!-- Distribution Bar -->
          <div class="dist-bar-container">
            <div class="dist-bar-label">
              <span style="color: var(--lp-color);">LP: <span id="lpPct">81%</span></span>
              <span style="color: var(--gp-color);">GP: <span id="gpPct">19%</span></span>
            </div>
            <div class="dist-bar">
              <div class="dist-bar-lp" id="lpBar" style="width: 81%;">$4.2B</div>
              <div class="dist-bar-gp" id="gpBar" style="width: 19%;">$1.0B</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2 class="panel-title">Complete Cash Flow</h2>

          <div class="cashflow-section">
            <div class="cashflow-header sources">üí∞ SOURCES OF CASH</div>
            
            <div class="cashflow-row source">
              <div class="cf-icon">üì•</div>
              <div class="cf-label">LP Commitment</div>
              <div class="cf-desc">Capital committed by limited partners</div>
              <div class="cf-amount" id="cfLpCommitment">$1,000M</div>
            </div>
          </div>

          <div class="cashflow-section">
            <div class="cashflow-header uses">üì§ USES OF CASH (Fund Operations)</div>
            
            <div class="cashflow-row expense">
              <div class="cf-icon">üè¢</div>
              <div class="cf-label">Management Fees</div>
              <div class="cf-desc" id="cfMgmtFeeDesc">2% √ó 10 years = 20% of fund</div>
              <div class="cf-amount negative" id="cfMgmtFee">-$200M</div>
            </div>
            
            <div class="cashflow-row expense">
              <div class="cf-icon">üìã</div>
              <div class="cf-label">Fund Expenses</div>
              <div class="cf-desc" id="cfExpenseDesc">Legal, admin, audit, etc.</div>
              <div class="cf-amount negative" id="cfExpenses">-$50M</div>
            </div>
            
            <div class="cashflow-row subtotal">
              <div class="cf-icon">‚Üí</div>
              <div class="cf-label">Investable Capital</div>
              <div class="cf-desc">Available for investments</div>
              <div class="cf-amount" id="cfInvestable">$750M</div>
            </div>
          </div>

          <div class="cashflow-section">
            <div class="cashflow-header investments">üéØ INVESTMENTS MADE</div>
            
            <div class="cashflow-row invest">
              <div class="cf-icon">üîç</div>
              <div class="cf-label">Discovery</div>
              <div class="cf-desc" id="cfDiscoveryDesc">146 positions @ $822K avg</div>
              <div class="cf-amount" id="cfDiscoveryInvest">$120M</div>
            </div>
            
            <div class="cashflow-row invest">
              <div class="cf-icon">üíé</div>
              <div class="cf-label">Core</div>
              <div class="cf-desc" id="cfCoreDesc">10 positions @ $54M avg</div>
              <div class="cf-amount" id="cfCoreInvest">$540M</div>
            </div>
            
            <div class="cashflow-row invest">
              <div class="cf-icon">üöÄ</div>
              <div class="cf-label">Breakout</div>
              <div class="cf-desc" id="cfBreakoutDesc">7 positions @ $12.9M avg</div>
              <div class="cf-amount" id="cfBreakoutInvest">$90M</div>
            </div>
            
            <div class="cashflow-row subtotal">
              <div class="cf-icon">‚Üí</div>
              <div class="cf-label">Total Deployed</div>
              <div class="cf-desc" id="cfDeployedPct">100% of investable</div>
              <div class="cf-amount" id="cfTotalDeployed">$750M</div>
            </div>
          </div>

          <div class="cashflow-section">
            <div class="cashflow-header returns">üìà RETURNS GENERATED</div>
            
            <div class="cashflow-row return">
              <div class="cf-icon">üîç</div>
              <div class="cf-label">Discovery Returns</div>
              <div class="cf-desc" id="cfDiscoveryReturnDesc">58 survivors √ó 3x multiple</div>
              <div class="cf-amount positive" id="cfDiscoveryReturn">$144M</div>
            </div>
            
            <div class="cashflow-row return">
              <div class="cf-icon">üíé</div>
              <div class="cf-label">Core Returns</div>
              <div class="cf-desc" id="cfCoreReturnDesc">7 survivors √ó 12x multiple</div>
              <div class="cf-amount positive" id="cfCoreReturn">$4,536M</div>
            </div>
            
            <div class="cashflow-row return">
              <div class="cf-icon">üöÄ</div>
              <div class="cf-label">Breakout Returns</div>
              <div class="cf-desc" id="cfBreakoutReturnDesc">6.3 survivors √ó 25x multiple</div>
              <div class="cf-amount positive" id="cfBreakoutReturn">$2,032M</div>
            </div>
            
            <div class="cashflow-row subtotal highlight-green">
              <div class="cf-icon">‚Üí</div>
              <div class="cf-label">Gross Proceeds</div>
              <div class="cf-desc" id="cfGrossMoicDesc">8.9x gross MOIC</div>
              <div class="cf-amount positive" id="cfGrossProceeds">$6,712M</div>
            </div>
          </div>

          <div class="cashflow-section">
            <div class="cashflow-header waterfall">‚¨áÔ∏è WATERFALL DISTRIBUTION</div>
            
            <div class="cashflow-row wf lp-style">
              <div class="cf-icon">1Ô∏è‚É£</div>
              <div class="cf-label">Return of Capital</div>
              <div class="cf-desc">LPs get their money back first</div>
              <div class="cf-amount lp-color" id="wfReturnCapitalLP">$1,000M</div>
            </div>
            
            <div class="cashflow-row wf lp-style">
              <div class="cf-icon">2Ô∏è‚É£</div>
              <div class="cf-label">Preferred Return</div>
              <div class="cf-desc" id="wfPrefDesc">8% hurdle compounded annually</div>
              <div class="cf-amount lp-color" id="wfPrefReturnLP">$1,159M</div>
            </div>
            
            <div class="cashflow-row wf gp-style">
              <div class="cf-icon">3Ô∏è‚É£</div>
              <div class="cf-label">GP Catch-up</div>
              <div class="cf-desc" id="wfCatchupDesc">GP catches up to 20% of profits</div>
              <div class="cf-amount gp-color" id="wfCatchupGP">$290M</div>
            </div>
            
            <div class="cashflow-row wf split-style">
              <div class="cf-icon">4Ô∏è‚É£</div>
              <div class="cf-label">Profit Split (80/20)</div>
              <div class="cf-desc" id="wfSplitDesc">Remaining split per carry terms</div>
              <div class="cf-amount split-amounts">
                <span class="lp-color" id="wfSplitLP">$3,410M LP</span>
                <span class="gp-color" id="wfSplitGP">$853M GP</span>
              </div>
            </div>
          </div>

          <div class="cashflow-section">
            <div class="cashflow-header totals">‚úÖ FINAL DISTRIBUTION</div>
            
            <div class="cashflow-row total lp-total">
              <div class="cf-icon">üë•</div>
              <div class="cf-label">LP Total</div>
              <div class="cf-desc" id="cfLpMoicDesc">5.6x net MOIC on $1B committed</div>
              <div class="cf-amount lp-color" id="wfTotalLP">$5,569M</div>
            </div>
            
            <div class="cashflow-row total gp-total">
              <div class="cf-icon">üé©</div>
              <div class="cf-label">GP Total</div>
              <div class="cf-desc" id="cfGpPctDesc">17% of gross proceeds</div>
              <div class="cf-amount gp-color" id="wfTotalGP">$1,143M</div>
            </div>
            
            <div class="cashflow-row verify">
              <div class="cf-icon">‚úì</div>
              <div class="cf-label">Verification</div>
              <div class="cf-desc">LP + GP = Gross Proceeds</div>
              <div class="cf-amount" id="cfVerify">$6,712M ‚úì</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2 class="panel-title">Engine breakdown</h2>

          <table class="breakdown-table">
            <thead>
              <tr>
                <th>Engine</th>
                <th>Capital</th>
                <th>Positions</th>
                <th>Avg check</th>
                <th>Survivors</th>
                <th>Gross return</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="engine">Discovery</td>
                <td id="discoveryCapital">$122M</td>
                <td id="discoveryPositions">146</td>
                <td id="discoveryCheck">$836K</td>
                <td id="discoverySurvivors">58</td>
                <td id="discoveryReturn" class="num pos">$390M</td>
              </tr>
              <tr>
                <td class="engine">Core</td>
                <td id="coreCapital">$608M</td>
                <td id="corePositions">10</td>
                <td id="coreCheck">$60.8M</td>
                <td id="coreSurvivors">7</td>
                <td id="coreReturn" class="num pos">$5.1B</td>
              </tr>
              <tr>
                <td class="engine">Breakout</td>
                <td id="breakoutCapital">$100M</td>
                <td id="breakoutPositions">3</td>
                <td id="breakoutCheck">$33.3M</td>
                <td id="breakoutSurvivors">2.7</td>
                <td id="breakoutReturn" class="num pos">$675M</td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td><strong>Total</strong></td>
                <td id="totalCapital"><strong>$830M</strong></td>
                <td id="totalPositions"><strong>159</strong></td>
                <td>‚Äî</td>
                <td id="totalSurvivors"><strong>68</strong></td>
                <td id="totalReturn" class="num"><strong>$6.1B</strong></td>
              </tr>
            </tfoot>
          </table>

          <div class="insight-box">
            <strong>Key insight:</strong> <span id="keyInsight">Core positions drive 82% of returns.</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Reference Section -->
    <div class="reference-section">
      <details class="reference-details">
        <summary class="reference-summary">üìä How the Math Works ‚Äî Reference Guide</summary>
        
        <div class="reference-content">
          <div class="ref-step">
            <h4>Step 1: Investable Capital</h4>
            <div class="formula-box">
              <code>Investable = Fund Size - (Mgmt Fee √ó Years) - (Expenses √ó Years)</code>
            </div>
            <p class="ref-example">Example: $1B - ($1B √ó 2% √ó 10) - ($1B √ó 0.5% √ó 10) = $750M</p>
          </div>

          <div class="ref-step">
            <h4>Step 2: Capital Deployment</h4>
            <div class="formula-box">
              <code>Layer Capital = Investable √ó Allocation %</code>
              <code>Check Size = Layer Capital / Position Count</code>
            </div>
            <p class="ref-example">Core: $750M √ó 72% = $540M ‚Üí 10 positions √ó $54M each</p>
          </div>

          <div class="ref-step">
            <h4>Step 3: Returns Calculation</h4>
            <div class="formula-box">
              <code>Survivors = Positions √ó (1 - Loss Rate)</code>
              <code>Layer Return = Survivors √ó Check Size √ó Multiple</code>
              <code>Gross Proceeds = Œ£ (All Layer Returns)</code>
            </div>
            <p class="ref-example">Core: 10 √ó (1-30%) √ó $54M √ó 12x = $4,536M</p>
          </div>

          <div class="ref-step">
            <h4>Step 4: Gross MOIC</h4>
            <div class="formula-box">
              <code>Gross MOIC = Gross Proceeds / Deployed Capital</code>
            </div>
            <p class="ref-example">$6.7B / $750M = 8.9x gross</p>
          </div>

          <div class="ref-step">
            <h4>Step 5: Waterfall Distribution</h4>
            <div class="waterfall-ref">
              <div class="wf-ref-row">
                <span class="wf-ref-num">1</span>
                <span class="wf-ref-name">Return of Capital</span>
                <span class="wf-ref-desc">LP gets 100% of committed capital first</span>
              </div>
              <div class="wf-ref-row">
                <span class="wf-ref-num">2</span>
                <span class="wf-ref-name">Preferred Return</span>
                <span class="wf-ref-desc">LP gets hurdle (e.g., 8% compounded annually)</span>
              </div>
              <div class="wf-ref-row">
                <span class="wf-ref-num">3</span>
                <span class="wf-ref-name">GP Catch-up</span>
                <span class="wf-ref-desc">GP catches up to carry % of profits so far</span>
              </div>
              <div class="wf-ref-row">
                <span class="wf-ref-num">4</span>
                <span class="wf-ref-name">Profit Split</span>
                <span class="wf-ref-desc">Remaining split 80/20 (or per carry terms)</span>
              </div>
            </div>
          </div>

          <div class="ref-step">
            <h4>Step 6: Net Returns</h4>
            <div class="formula-box">
              <code>Net MOIC = LP Total / Fund Size</code>
              <code>Net IRR = (Net MOIC)^(1/years) - 1</code>
            </div>
            <p class="ref-example">$5.6B / $1B = 5.6x net ‚Üí 18.8% IRR over 10 years</p>
          </div>

          <div class="ref-step">
            <h4>Fund Performance Ratios</h4>
            <table class="ref-table">
              <tr><td><strong>TVPI</strong></td><td>Total Value to Paid-In = (Distributions + NAV) / Called Capital</td></tr>
              <tr><td><strong>DPI</strong></td><td>Distributions to Paid-In = Realized Distributions / Called Capital</td></tr>
              <tr><td><strong>RVPI</strong></td><td>Residual Value to Paid-In = Unrealized NAV / Called Capital</td></tr>
              <tr><td><strong>Note</strong></td><td>TVPI = DPI + RVPI. For a fully realized fund, DPI = TVPI and RVPI = 0</td></tr>
            </table>
          </div>

          <div class="ref-step">
            <h4>Key Relationships</h4>
            <table class="ref-table">
              <tr><td><strong>‚Üë Fund Size</strong></td><td>‚Üí ‚Üë Investable ‚Üí ‚Üë Check sizes (same positions)</td></tr>
              <tr><td><strong>‚Üë Mgmt Fee</strong></td><td>‚Üí ‚Üì Investable ‚Üí ‚Üì Gross proceeds ‚Üí ‚Üì Net MOIC</td></tr>
              <tr><td><strong>‚Üë Allocation %</strong></td><td>‚Üí ‚Üë Layer capital ‚Üí ‚Üë That layer's returns</td></tr>
              <tr><td><strong>‚Üë Multiple</strong></td><td>‚Üí ‚Üë Gross proceeds ‚Üí ‚Üë Both GP and LP</td></tr>
              <tr><td><strong>‚Üë Loss Rate</strong></td><td>‚Üí ‚Üì Survivors ‚Üí ‚Üì Returns</td></tr>
              <tr><td><strong>‚Üë Hurdle</strong></td><td>‚Üí ‚Üë LP pref return ‚Üí ‚Üì GP catch-up needed</td></tr>
              <tr><td><strong>‚Üë Carry %</strong></td><td>‚Üí ‚Üë GP share ‚Üí ‚Üì LP net MOIC</td></tr>
            </table>
          </div>
        </div>
      </details>
    </div>

  </main>

  <footer class="footer">
    <p>VC Fund Model Simulator ¬∑ Full waterfall analysis</p>
  </footer>

  <script>
    const inputs = {
      fundSize: document.getElementById('fundSize'),
      mgmtFee: document.getElementById('mgmtFee'),
      expenseRatio: document.getElementById('expenseRatio'),
      fundLife: document.getElementById('fundLife'),
      targetMoic: document.getElementById('targetMoic'),
      carryPct: document.getElementById('carryPct'),
      hurdleRate: document.getElementById('hurdleRate'),
      catchupPct: document.getElementById('catchupPct'),
      discoveryPct: document.getElementById('discoveryPct'),
      corePct: document.getElementById('corePct'),
      breakoutPct: document.getElementById('breakoutPct'),
      discoveryCount: document.getElementById('discoveryCount'),
      coreCount: document.getElementById('coreCount'),
      breakoutCount: document.getElementById('breakoutCount'),
      discoveryMult: document.getElementById('discoveryMult'),
      coreMult: document.getElementById('coreMult'),
      breakoutMult: document.getElementById('breakoutMult'),
      discoveryLoss: document.getElementById('discoveryLoss'),
      coreLoss: document.getElementById('coreLoss'),
      breakoutLoss: document.getElementById('breakoutLoss'),
    };

    const sliderDisplays = {
      mgmtFee: document.getElementById('mgmtFeeVal'),
      mgmtFeeDollar: document.getElementById('mgmtFeeDollar'),
      expenseRatio: document.getElementById('expenseRatioVal'),
      expenseRatioDollar: document.getElementById('expenseRatioDollar'),
      carryPct: document.getElementById('carryPctVal'),
      hurdleRate: document.getElementById('hurdleRateVal'),
      catchupPct: document.getElementById('catchupPctVal'),
      discoveryPct: document.getElementById('discoveryPctVal'),
      corePct: document.getElementById('corePctVal'),
      breakoutPct: document.getElementById('breakoutPctVal'),
      discoveryLoss: document.getElementById('discoveryLossVal'),
      coreLoss: document.getElementById('coreLossVal'),
      breakoutLoss: document.getElementById('breakoutLossVal'),
    };

    function formatMoney(val, decimals = 0) {
      if (val >= 1e9) return '$' + (val / 1e9).toFixed(1) + 'B';
      if (val >= 1e6) return '$' + (val / 1e6).toFixed(decimals) + 'M';
      if (val >= 1e3) return '$' + (val / 1e3).toFixed(0) + 'K';
      return '$' + val.toFixed(0);
    }

    function calculateIRR(investable, grossProceeds, years) {
      if (grossProceeds <= 0 || investable <= 0) return 0;
      const moic = grossProceeds / investable;
      const irr = Math.pow(moic, 1/years) - 1;
      return irr;
    }

    function calculate() {
      const fundSize = parseFloat(inputs.fundSize.value) * 1e6;
      const mgmtFee = parseFloat(inputs.mgmtFee.value) / 100;
      const expenseRatio = parseFloat(inputs.expenseRatio.value) / 100;
      const fundLife = parseFloat(inputs.fundLife.value);
      const targetMoic = parseFloat(inputs.targetMoic.value);
      const carryPct = parseFloat(inputs.carryPct.value) / 100;
      const hurdleRate = parseFloat(inputs.hurdleRate.value) / 100;
      const catchupPct = parseFloat(inputs.catchupPct.value) / 100;

      const discoveryPct = parseFloat(inputs.discoveryPct.value) / 100;
      const corePct = parseFloat(inputs.corePct.value) / 100;
      const breakoutPct = parseFloat(inputs.breakoutPct.value) / 100;

      const discoveryCount = parseInt(inputs.discoveryCount.value);
      const coreCount = parseInt(inputs.coreCount.value);
      const breakoutCount = parseInt(inputs.breakoutCount.value);

      const discoveryMult = parseFloat(inputs.discoveryMult.value);
      const coreMult = parseFloat(inputs.coreMult.value);
      const breakoutMult = parseFloat(inputs.breakoutMult.value);

      const discoveryLoss = parseFloat(inputs.discoveryLoss.value) / 100;
      const coreLoss = parseFloat(inputs.coreLoss.value) / 100;
      const breakoutLoss = parseFloat(inputs.breakoutLoss.value) / 100;

      const mgmtFeeDollars = fundSize * mgmtFee * fundLife;
      const expenseRatioDollars = fundSize * expenseRatio * fundLife;
      
      sliderDisplays.mgmtFee.textContent = (mgmtFee * 100).toFixed(2) + '%';
      sliderDisplays.mgmtFeeDollar.textContent = formatMoney(mgmtFeeDollars);
      sliderDisplays.expenseRatio.textContent = (expenseRatio * 100).toFixed(1) + '%';
      sliderDisplays.expenseRatioDollar.textContent = formatMoney(expenseRatioDollars);
      sliderDisplays.carryPct.textContent = (carryPct * 100).toFixed(0) + '%';
      sliderDisplays.hurdleRate.textContent = (hurdleRate * 100).toFixed(0) + '%';
      sliderDisplays.catchupPct.textContent = (catchupPct * 100).toFixed(0) + '%';
      sliderDisplays.discoveryPct.textContent = (discoveryPct * 100).toFixed(0) + '%';
      sliderDisplays.corePct.textContent = (corePct * 100).toFixed(0) + '%';
      sliderDisplays.breakoutPct.textContent = (breakoutPct * 100).toFixed(0) + '%';
      
      // Update allocation total
      const totalAllocation = discoveryPct + corePct + breakoutPct;
      const totalAllocationPct = (totalAllocation * 100).toFixed(0);
      const allocationTotalEl = document.getElementById('allocationTotal');
      const allocationValueEl = document.getElementById('allocationValue');
      const allocationWarningEl = document.getElementById('allocationWarning');
      const allocationMissingEl = document.getElementById('allocationMissing');
      
      allocationValueEl.textContent = totalAllocationPct + '%';
      
      if (Math.abs(totalAllocation - 1) < 0.001) {
        allocationTotalEl.classList.add('valid');
        allocationTotalEl.classList.remove('invalid');
        allocationWarningEl.style.display = 'none';
      } else {
        allocationTotalEl.classList.remove('valid');
        allocationTotalEl.classList.add('invalid');
        allocationWarningEl.style.display = 'inline';
        const missing = ((1 - totalAllocation) * 100).toFixed(0);
        if (totalAllocation < 1) {
          allocationMissingEl.textContent = missing + '% unallocated';
        } else {
          allocationMissingEl.textContent = Math.abs(missing) + '% over-allocated';
        }
      }

      sliderDisplays.discoveryLoss.textContent = (discoveryLoss * 100).toFixed(0) + '%';
      sliderDisplays.coreLoss.textContent = (coreLoss * 100).toFixed(0) + '%';
      sliderDisplays.breakoutLoss.textContent = (breakoutLoss * 100).toFixed(0) + '%';

      const totalFees = mgmtFeeDollars + expenseRatioDollars;
      const investable = fundSize - totalFees;

      const deployedCapital = investable * totalAllocation;
      
      const discoveryCapital = investable * discoveryPct;
      const coreCapital = investable * corePct;
      const breakoutCapital = investable * breakoutPct;

      const discoveryCheck = discoveryCapital / discoveryCount;
      const coreCheck = coreCapital / coreCount;
      const breakoutCheck = breakoutCapital / breakoutCount;

      const discoverySurvivors = discoveryCount * (1 - discoveryLoss);
      const coreSurvivors = coreCount * (1 - coreLoss);
      const breakoutSurvivors = breakoutCount * (1 - breakoutLoss);

      const discoveryReturn = discoverySurvivors * discoveryCheck * discoveryMult;
      const coreReturn = coreSurvivors * coreCheck * coreMult;
      const breakoutReturn = breakoutSurvivors * breakoutCheck * breakoutMult;

      const grossProceeds = discoveryReturn + coreReturn + breakoutReturn;
      const grossMoic = deployedCapital > 0 ? grossProceeds / deployedCapital : 0;

      let remaining = grossProceeds;
      let lpTotal = 0;
      let gpTotal = 0;

      const returnOfCapital = Math.min(remaining, fundSize);
      lpTotal += returnOfCapital;
      remaining -= returnOfCapital;

      const prefReturn = fundSize * (Math.pow(1 + hurdleRate, fundLife) - 1);
      const actualPrefReturn = Math.min(remaining, prefReturn);
      lpTotal += actualPrefReturn;
      remaining -= actualPrefReturn;

      let gpCatchup = 0;
      if (catchupPct > 0 && remaining > 0) {
        const fullCatchup = (actualPrefReturn * carryPct) / (1 - carryPct);
        gpCatchup = Math.min(remaining, fullCatchup * catchupPct);
        gpTotal += gpCatchup;
        remaining -= gpCatchup;
      }

      const lpSplit = remaining * (1 - carryPct);
      const gpSplit = remaining * carryPct;
      lpTotal += lpSplit;
      gpTotal += gpSplit;

      const lpMoic = lpTotal / fundSize;
      const netMoic = lpMoic;
      const netIrr = calculateIRR(fundSize, lpTotal, fundLife);

      document.getElementById('netMoic').textContent = netMoic.toFixed(1) + 'x';
      document.getElementById('grossMoic').textContent = grossMoic.toFixed(1) + 'x';
      document.getElementById('netIrr').textContent = (netIrr * 100).toFixed(1) + '%';
      document.getElementById('investable').textContent = formatMoney(investable);
      document.getElementById('deployedCapital').textContent = formatMoney(deployedCapital);
      document.getElementById('deployedPct').textContent = '(' + (totalAllocation * 100).toFixed(0) + '%)';
      document.getElementById('grossProceeds').textContent = formatMoney(grossProceeds);
      document.getElementById('lpTotal').textContent = formatMoney(lpTotal);
      document.getElementById('gpTotal').textContent = formatMoney(gpTotal);
      document.getElementById('lpMoic').textContent = lpMoic.toFixed(1) + 'x';

      // TVPI, DPI, RVPI calculations
      // For a fully realized fund model (all exits complete):
      // - TVPI = (Distributions + NAV) / Paid-In Capital = LP Total / Fund Size
      // - DPI = Distributions / Paid-In Capital = LP Total / Fund Size (fully realized)
      // - RVPI = NAV / Paid-In Capital = 0 (no remaining unrealized value)
      const tvpi = lpTotal / fundSize;
      const dpi = lpTotal / fundSize;  // Fully realized, so DPI = TVPI
      const rvpi = 0;  // No unrealized value in this model
      
      document.getElementById('tvpi').textContent = tvpi.toFixed(1) + 'x';
      document.getElementById('dpi').textContent = dpi.toFixed(1) + 'x';
      document.getElementById('rvpi').textContent = rvpi.toFixed(1) + 'x';

      const lpPctVal = (lpTotal / grossProceeds * 100).toFixed(0);
      const gpPctVal = (gpTotal / grossProceeds * 100).toFixed(0);
      document.getElementById('lpPct').textContent = lpPctVal + '%';
      document.getElementById('gpPct').textContent = gpPctVal + '%';
      document.getElementById('lpBar').style.width = lpPctVal + '%';
      document.getElementById('lpBar').textContent = formatMoney(lpTotal);
      document.getElementById('gpBar').style.width = gpPctVal + '%';
      document.getElementById('gpBar').textContent = formatMoney(gpTotal);

      // Cash Flow Section - Sources
      document.getElementById('cfLpCommitment').textContent = formatMoney(fundSize);
      
      // Cash Flow Section - Uses
      document.getElementById('cfMgmtFee').textContent = '-' + formatMoney(mgmtFeeDollars);
      document.getElementById('cfMgmtFeeDesc').textContent = `${(mgmtFee*100).toFixed(1)}% √ó ${fundLife} years`;
      document.getElementById('cfExpenses').textContent = '-' + formatMoney(expenseRatioDollars);
      document.getElementById('cfExpenseDesc').textContent = `${(expenseRatio*100).toFixed(1)}% √ó ${fundLife} years`;
      document.getElementById('cfInvestable').textContent = formatMoney(investable);
      
      // Cash Flow Section - Investments
      document.getElementById('cfDiscoveryInvest').textContent = formatMoney(discoveryCapital);
      document.getElementById('cfDiscoveryDesc').textContent = `${discoveryCount} positions @ ${formatMoney(discoveryCheck)} avg`;
      document.getElementById('cfCoreInvest').textContent = formatMoney(coreCapital);
      document.getElementById('cfCoreDesc').textContent = `${coreCount} positions @ ${formatMoney(coreCheck)} avg`;
      document.getElementById('cfBreakoutInvest').textContent = formatMoney(breakoutCapital);
      document.getElementById('cfBreakoutDesc').textContent = `${breakoutCount} positions @ ${formatMoney(breakoutCheck)} avg`;
      document.getElementById('cfTotalDeployed').textContent = formatMoney(deployedCapital);
      document.getElementById('cfDeployedPct').textContent = `${(totalAllocation * 100).toFixed(0)}% of investable`;
      
      // Cash Flow Section - Returns
      document.getElementById('cfDiscoveryReturn').textContent = formatMoney(discoveryReturn);
      document.getElementById('cfDiscoveryReturnDesc').textContent = `${Math.round(discoverySurvivors)} survivors √ó ${discoveryMult}x`;
      document.getElementById('cfCoreReturn').textContent = formatMoney(coreReturn);
      document.getElementById('cfCoreReturnDesc').textContent = `${coreSurvivors.toFixed(1)} survivors √ó ${coreMult}x`;
      document.getElementById('cfBreakoutReturn').textContent = formatMoney(breakoutReturn);
      document.getElementById('cfBreakoutReturnDesc').textContent = `${breakoutSurvivors.toFixed(1)} survivors √ó ${breakoutMult}x`;
      document.getElementById('cfGrossProceeds').textContent = formatMoney(grossProceeds);
      document.getElementById('cfGrossMoicDesc').textContent = `${grossMoic.toFixed(1)}x gross MOIC`;
      
      // Cash Flow Section - Waterfall
      document.getElementById('wfReturnCapitalLP').textContent = formatMoney(returnOfCapital);
      document.getElementById('wfPrefDesc').textContent = `${(hurdleRate*100).toFixed(0)}% hurdle compounded over ${fundLife} years`;
      document.getElementById('wfPrefReturnLP').textContent = formatMoney(actualPrefReturn);
      document.getElementById('wfCatchupDesc').textContent = `GP catches up to ${(carryPct*100).toFixed(0)}% of profits`;
      document.getElementById('wfCatchupGP').textContent = formatMoney(gpCatchup);
      document.getElementById('wfSplitDesc').textContent = `Remaining split ${((1-carryPct)*100).toFixed(0)}/${(carryPct*100).toFixed(0)}`;
      document.getElementById('wfSplitLP').textContent = formatMoney(lpSplit) + ' LP';
      document.getElementById('wfSplitGP').textContent = formatMoney(gpSplit) + ' GP';
      document.getElementById('wfTotalLP').textContent = formatMoney(lpTotal);
      document.getElementById('wfTotalGP').textContent = formatMoney(gpTotal);
      
      // Cash Flow Section - Final
      document.getElementById('cfLpMoicDesc').textContent = `${netMoic.toFixed(1)}x net MOIC on ${formatMoney(fundSize)} committed`;
      document.getElementById('cfGpPctDesc').textContent = `${gpPctVal}% of gross proceeds`;
      document.getElementById('cfVerify').textContent = formatMoney(lpTotal + gpTotal) + ' ‚úì';

      document.getElementById('discoveryCapital').textContent = formatMoney(discoveryCapital);
      document.getElementById('discoveryPositions').textContent = discoveryCount;
      document.getElementById('discoveryCheck').textContent = formatMoney(discoveryCheck);
      document.getElementById('discoverySurvivors').textContent = Math.round(discoverySurvivors);
      document.getElementById('discoveryReturn').textContent = formatMoney(discoveryReturn);

      document.getElementById('coreCapital').textContent = formatMoney(coreCapital);
      document.getElementById('corePositions').textContent = coreCount;
      document.getElementById('coreCheck').textContent = formatMoney(coreCheck, 1);
      document.getElementById('coreSurvivors').textContent = coreSurvivors.toFixed(1);
      document.getElementById('coreReturn').textContent = formatMoney(coreReturn);

      document.getElementById('breakoutCapital').textContent = formatMoney(breakoutCapital);
      document.getElementById('breakoutPositions').textContent = breakoutCount;
      document.getElementById('breakoutCheck').textContent = formatMoney(breakoutCheck, 1);
      document.getElementById('breakoutSurvivors').textContent = breakoutSurvivors.toFixed(1);
      document.getElementById('breakoutReturn').textContent = formatMoney(breakoutReturn);

      document.getElementById('totalCapital').innerHTML = '<strong>' + formatMoney(deployedCapital) + '</strong>';
      document.getElementById('totalPositions').innerHTML = '<strong>' + (discoveryCount + coreCount + breakoutCount) + '</strong>';
      document.getElementById('totalSurvivors').innerHTML = '<strong>' + Math.round(discoverySurvivors + coreSurvivors + breakoutSurvivors) + '</strong>';
      document.getElementById('totalReturn').innerHTML = '<strong>' + formatMoney(grossProceeds) + '</strong>';

      const statusEl = document.getElementById('scenarioStatus');
      const netMoicEl = document.getElementById('netMoic');
      const netIrrEl = document.getElementById('netIrr');
      
      if (netMoic >= targetMoic) {
        statusEl.className = 'scenario-status success';
        statusEl.innerHTML = `<strong>Target achievable</strong> ‚Äî ${netMoic.toFixed(1)}x net MOIC / ${(netIrr*100).toFixed(1)}% net IRR (target: ${targetMoic}x)`;
        netMoicEl.className = 'output-value green';
        netIrrEl.className = 'output-value green';
      } else if (netMoic >= targetMoic * 0.8) {
        statusEl.className = 'scenario-status warning';
        statusEl.innerHTML = `<strong>Close to target</strong> ‚Äî ${netMoic.toFixed(1)}x net MOIC / ${(netIrr*100).toFixed(1)}% net IRR (target: ${targetMoic}x)`;
        netMoicEl.className = 'output-value';
        netMoicEl.style.color = 'var(--yellow)';
        netIrrEl.className = 'output-value';
        netIrrEl.style.color = 'var(--yellow)';
      } else {
        statusEl.className = 'scenario-status danger';
        statusEl.innerHTML = `<strong>Below target</strong> ‚Äî ${netMoic.toFixed(1)}x net MOIC / ${(netIrr*100).toFixed(1)}% net IRR (target: ${targetMoic}x)`;
        netMoicEl.className = 'output-value red';
        netIrrEl.className = 'output-value red';
      }

      const coreContribution = coreReturn / grossProceeds * 100;
      document.getElementById('keyInsight').textContent = 
        `Core positions drive ${coreContribution.toFixed(0)}% of gross returns. GP takes home ${formatMoney(gpTotal)} (${gpPctVal}% of proceeds).`;
    }

    Object.values(inputs).forEach(input => {
      input.addEventListener('input', calculate);
    });

    calculate();

    const STORAGE_KEY = 'fundModelVersions';

    function getVersions() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveVersions(versions) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(versions));
    }

    function getCurrentState() {
      const state = {};
      Object.keys(inputs).forEach(key => {
        state[key] = inputs[key].value;
      });
      return state;
    }

    function loadState(state) {
      Object.keys(state).forEach(key => {
        if (inputs[key]) {
          inputs[key].value = state[key];
        }
      });
      calculate();
    }

    function saveVersion() {
      const nameInput = document.getElementById('versionName');
      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter a version name');
        return;
      }

      const versions = getVersions();
      const newVersion = {
        id: Date.now(),
        name: name,
        state: getCurrentState(),
        createdAt: new Date().toISOString()
      };
      versions.unshift(newVersion);
      saveVersions(versions);
      nameInput.value = '';
      renderVersions();
    }

    function loadVersion(id) {
      const versions = getVersions();
      const version = versions.find(v => v.id === id);
      if (version) {
        loadState(version.state);
      }
    }

    function deleteVersion(id) {
      const versions = getVersions().filter(v => v.id !== id);
      saveVersions(versions);
      renderVersions();
    }

    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderVersions() {
      const container = document.getElementById('versionList');
      const versions = getVersions();

      if (versions.length === 0) {
        container.innerHTML = '<div class="version-empty">No saved versions yet</div>';
        return;
      }

      container.innerHTML = versions.map(v => `
        <div class="version-item">
          <div class="version-name" onclick="loadVersion(${v.id})" title="Click to load">
            ${v.name}
            <div class="version-meta">${formatDate(v.createdAt)}</div>
          </div>
          <button class="btn btn-sm btn-ghost" onclick="loadVersion(${v.id})">Load</button>
          <button class="btn btn-sm btn-ghost btn-danger" onclick="deleteVersion(${v.id})">‚úï</button>
        </div>
      `).join('');
    }

    renderVersions();
  </script>

</body>
</html>
